var finalText="";
$(document).ready(
    function(){
        $('[data-action="Encode"]').click(
            function(){
                $("#error").empty();
                try{
                    finalText=Base64.encode($("#Source").val())
                }catch(n){
                    $("#error").html("<b>Error encodig<\/b>")
                }
                $("#Source").val(finalText)
            }
        );
        $('[data-action="Decode"]').click(
            function(){
                $("#error").empty();
                try{
                    finalText=Base64.decode($("#Source").val())
                }catch(n){
                    $("#error").html("<b>Error decoding<\/b>")
                }
            $("#Source").val(finalText)
        });
        initText();
        chrome.tabs.getSelected(function(tab) {
            // var favicon_dom = $_id("favicon");
            var qrcode_dom = $_id("qrcode_img");
        
            // favicon_dom.onerror = function() {
            //     favicon_dom.src = "icon/icon_32.png";
            //     favicon_dom.onerror = null;
            // }
            // if (tab.favIconUrl) {
            //     favicon_dom.src = tab.favIconUrl;
            //     show(favicon_dom);
            // }
            
            var url = tab.url || "http://www.atool.org";
            $("#qr_text_source").val(url);
            var options = get_qrcode_option(url, 8);
            try { 
                qrcode_dom.src = qrgen.canvas(options).toDataURL();
            } catch (e) {
                console.log(e);
            }
            //选中文本复制
            $_id("qr_encode").onclick = function() {
                options.data = $("#qr_text_source").val();
                qrcode_dom.src = qrgen.canvas(options).toDataURL();
                
            }
        });
    }
);

function $_id(id) {
    return document.getElementById(id);
}

function initText() {
    var base64_name = $_id("base64_name");
    base64_name.innerText = chrome.i18n.getMessage("Base64_name")+" :";
    var qr_name = $_id("qr_name");
    qr_name.innerText = chrome.i18n.getMessage("qr_name")+" :";
}
